(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([["chunk-2050818b"],{"88dd":function(e,n,t){"use strict";t.r(n);var r=function(){var e=this,n=e.$createElement,t=e._self._c||n;return t("video",{staticStyle:{height:"100%",width:"100%"},attrs:{id:e.videoId+"-video",playsinline:"",autoplay:""},on:{dblclick:e.maximize}})},i=[],a=(t("4160"),t("c975"),t("4d63"),t("ac1f"),t("25f0"),t("5319"),t("159b"),t("96cf"),t("1da1")),o=t("ec26");function c(e){var n=new Date;console.log("["+n.toLocaleTimeString()+"] "+e)}function s(e){var n=new Date;console.trace("["+n.toLocaleTimeString()+"] "+JSON.stringify(e))}var d={name:"Video",props:{cameraId:{type:String,required:!1},channelId:{type:String,required:!1}},data:function(){return{instanceId:null,videoId:null,reqId:null,chId:null,childIds:[],videoElement:null,BROAD_CHANNEL:null,options:{iceServerUrls:null,iceServerUsername:null,iceServerCredential:null,audioBandWidth:50,videoBandWith:500},peerConnection:null,isActive:!1}},created:function(){var e=this;this.videoId=this.cameraId?this.cameraId:this.$route.params.cameraId,this.chId=this.channelId?this.channelId:this.$route.params.cid,this.BROAD_CHANNEL=new BroadcastChannel(this.chId),this.isActive=!0,this.BROAD_CHANNEL.onmessage=function(n){var t=JSON.parse(n.data),r=t.type,i=t.payload;if(!i.camera||i.camera===e.videoId)switch(r){case"init-rtc-connection":e.handleInitRtcConnectionMessage(i);break;case"video-answer":e.handleVideoAnswerMessage(i);break;case"video-notify-answer":e.handleVideoNotifyMessage(i);break;case"new-ice-candidate":e.handleNewICECandidateMessage(i);break;case"destroy-rtc-connection":e.handleDestroyRtcConnectionMessage(i);break;case"video-active":e.isActive=!0;break;case"video-destroy":e.isActive=!1,e.destroy();break}},this.$nextTick((function(){e.videoElement=document.getElementById(e.videoId+"-video")}))},mounted:function(){var e=this;window.addEventListener("beforeunload",(function(n){return e.activeVideo(n)})),this.BROAD_CHANNEL.postMessage(JSON.stringify({type:"registry",payload:{}}))},destroyed:function(){var e=this;window.removeEventListener("beforeunload",(function(n){return e.activeVideo(n)}))},methods:{activeVideo:function(e){this.BROAD_CHANNEL.postMessage(JSON.stringify({type:"video-active",payload:{}})),this.BROAD_CHANNEL.close()},maximize:function(){this.$route.params.cameraId?this.$message({type:"error",message:"当前已经是扩展页面，不支持再次扩展！"}):(this.isActive=!1,this.destroy(),window.open("#/expand/video/"+this.chId+"/"+this.videoId))},handleVideoAnswerMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){var r,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.id,r===n.reqId){t.next=3;break}return t.abrupt("return");case 3:if(i=new RTCSessionDescription(e.sdp),!n.peerConnection){t.next=7;break}return t.next=7,n.peerConnection.setRemoteDescription(i).catch(s);case 7:case"end":return t.stop()}}),t)})))()},handleVideoNotifyMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.id,r!==n.reqId||"ready"!==e.status){t.next=4;break}return t.next=4,n.createVideoOffer();case 4:case"end":return t.stop()}}),t)})))()},handleNewICECandidateMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){var r,i;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:if(r=e.id,r===n.reqId){t.next=3;break}return t.abrupt("return");case 3:return i=new RTCIceCandidate(e.candidate),c("*** Adding received ICE candidate: "+JSON.stringify(i)),t.prev=5,t.next=8,n.peerConnection.addIceCandidate(i);case 8:t.next=13;break;case 10:t.prev=10,t.t0=t["catch"](5),s(t.t0);case 13:case"end":return t.stop()}}),t,null,[[5,10]])})))()},sendMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:e.camera=n.videoId,e.id=n.reqId,n.BROAD_CHANNEL.postMessage(JSON.stringify({type:"send-message",payload:e})),c("Send message:"+e);case 4:case"end":return t.stop()}}),t)})))()},handleInitRtcConnectionMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){var r,i,a;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:!n.peerConnection&&n.isActive&&(c("** Init rtc connection."),r=e,Object.assign(n.options,e),i={iceServers:[{urls:r.iceServerUrls,username:r.iceServerUsername,credential:r.iceServerCredential}],sdpSemantics:"unified-plan",bundlePolicy:"max-compat"},n.reqId=Object(o["a"])(),a=new RTCPeerConnection(i),a.onicecandidate=n.handleICECandidateEvent,a.onsignalingstatechange=n.handleSignalingStateChangeEvent,a.ontrack=n.handleTrackEvent,n.peerConnection=a,n.sendMessage({type:"video-request-notify",id:n.reqId}));case 1:case"end":return t.stop()}}),t)})))()},handleDestroyRtcConnectionMessage:function(e){var n=this;return Object(a["a"])(regeneratorRuntime.mark((function t(){var r;return regeneratorRuntime.wrap((function(t){while(1)switch(t.prev=t.next){case 0:r=e.id,r===n.reqId&&n.peerConnection&&n.peerConnection.close();case 2:case"end":return t.stop()}}),t)})))()},removeBandwidthRestriction:function(e){return e.replace(/b=AS:.*\r\n/,"").replace(/b=TIAS:.*\r\n/,"")},updateBandwidthRestriction:function(e){var n=this.options.videoBandWith;if("unlimited"===n)return this.removeBandwidthRestriction(e);var t="AS";return"firefox"===adapter.browserDetails.browser&&(n=1e3*(n>>>0),t="TIAS"),e=-1===e.indexOf("b="+t+":")?e.replace(/c=IN (.*)\r\n/,"c=IN $1\r\nb="+t+":"+n+"\r\n"):e.replace(new RegExp("b="+t+":.*\r\n"),"b="+t+":"+n+"\r\n"),e},createVideoOffer:function(){var e=this;return Object(a["a"])(regeneratorRuntime.mark((function n(){var t;return regeneratorRuntime.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return n.prev=0,t=e,c("*** Create offer."),n.next=5,e.peerConnection.createOffer(function(){var e=Object(a["a"])(regeneratorRuntime.mark((function e(n){return regeneratorRuntime.wrap((function(e){while(1)switch(e.prev=e.next){case 0:return n.sdp=t.updateBandwidthRestriction(n.sdp),e.next=3,t.peerConnection.setLocalDescription(n);case 3:t.sendMessage({type:"video-request",sdp:t.peerConnection.localDescription});case 4:case"end":return e.stop()}}),e)})));return function(n){return e.apply(this,arguments)}}(),(function(e){}),{offerToReceiveAudio:!1,offerToReceiveVideo:!0});case 5:n.next=10;break;case 7:n.prev=7,n.t0=n["catch"](0),s("*** The following error occurred while RequestVideo.");case 10:case"end":return n.stop()}}),n,null,[[0,7]])})))()},handleICECandidateEvent:function(e){e.candidate&&this.sendMessage({type:"new-ice-candidate",candidate:e.candidate})},handleSignalingStateChangeEvent:function(e){},handleTrackEvent:function(e){this.videoElement.srcObject=e.streams[0]},destroy:function(){this.videoElement.srcObject&&(this.videoElement.pause(),this.videoElement.srcObject.getTracks().forEach((function(e){e.stop()})),this.videoElement.srcObject=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null)}}},u=d,l=t("2877"),p=Object(l["a"])(u,r,i,!1,null,"76c5c974",null);n["default"]=p.exports},ec26:function(e,n,t){"use strict";var r="undefined"!==typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!==typeof msCrypto&&"function"===typeof msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto),i=new Uint8Array(16);function a(){if(!r)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return r(i)}var o=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;function c(e){return"string"===typeof e&&o.test(e)}for(var s=c,d=[],u=0;u<256;++u)d.push((u+256).toString(16).substr(1));function l(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,t=(d[e[n+0]]+d[e[n+1]]+d[e[n+2]]+d[e[n+3]]+"-"+d[e[n+4]]+d[e[n+5]]+"-"+d[e[n+6]]+d[e[n+7]]+"-"+d[e[n+8]]+d[e[n+9]]+"-"+d[e[n+10]]+d[e[n+11]]+d[e[n+12]]+d[e[n+13]]+d[e[n+14]]+d[e[n+15]]).toLowerCase();if(!s(t))throw TypeError("Stringified UUID is invalid");return t}var p=l;function h(e,n,t){e=e||{};var r=e.random||(e.rng||a)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,n){t=t||0;for(var i=0;i<16;++i)n[t+i]=r[i];return n}return p(r)}n["a"]=h}}]);